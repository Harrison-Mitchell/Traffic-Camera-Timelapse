import urllib, shutil, os, time
from urllib.request import urlretrieve
from PIL import Image, ImageFile
# Occasionally images aren't processed properly on RMS's end, this fixes that
ImageFile.LOAD_TRUNCATED_IMAGES = True
# Requires manual stop, cron job is the better solution but that's difficult with windows
# This is a bad practice workaround
while True:
	if str(time.localtime().tm_sec) == "0": # Once a minute
		os.mkdir("images")
		num = 0
		# Hardcoded to use up less resources
		cams = ['http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/5ways.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/alisonrd_randwick.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/anzacbr.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/anzacpde.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/churchst_parra.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/citywestlink.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/cumberlandhwy_carlingford.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/cumberlandhwy_merrylands.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/easterndist.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/f3_kariong.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/f3_mooney.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/f3_mountwhite.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/f3_ourimbah.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/f3_wahroonga.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/f3_windybanks.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/falconst_crowsnest.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/ghd_airport.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/williamst.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/gladesvillebr.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/humehwy_ashfield.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/humehwy_bankstown.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/humehwy_campbelltown.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/humehwy_liverpool.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/humehwy_standrews.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/humehwy_strathfield.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/humehwy_villawood.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/jrd_rosehill.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/knggrd_beverlyhills.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/m2_pennanthills.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/m2_ryde.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/m4_minchinbury.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/m4_olympic.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/m4_prospect.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/m4_stmarys.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/m5_m7.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/m5_liverpool.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/m5_milperra.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/m5east.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/m7_glenwood.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/m7_horsleydr.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/manlyrd.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/militaryrd_neutralbay.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/oldwindsorrd.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/oldwindsorrd_winstonhills.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/pacific_chats.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/pacific_pymble.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/parrard_leichhardt.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/parrard_parra.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/parrard_silverwater.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/parrard_strathfield.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/pittwaterrd_narrabeen.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/princes_blakehurst.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/princes_kogarah.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/princes_stpeters.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/rydebridge.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/sevenhillsrd_sevenhills.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/scd_eastlakes.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/stewartst_eastwood.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/sed_bondijunction.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/harbourbridge.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/grandpde_bls.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/victoriard_gladesville.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/warringahfwy.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/warringahrd_forestville.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/warringahrd_frenchsforest.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/georgest.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/kosciuszkord_wilsonsvalley.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/eppingrd_macquariepark.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/pennanthillsrd_thornleigh.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/m4_auburn.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/eppingrd_lanecove.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/greatwesternhwy_hazelbrook.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/audleyrd_audley.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/beecroftrd_epping.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/f3_johnrenshawdr.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/f3_sparkesrd.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/f6_waterfall.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/f6_mtousley.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/gorehillfwy_artarmon.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/m4_mayshill.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/m5_padstow.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/newenglandhwy_hexham.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/newcastlelinkrd_newcastle.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/princeshwy_albionparkrail.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/princeshwy_sutherland.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/silverwaterrd_silverwater.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/princeshwy_wollongong.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/hunterexpressway_m1.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/m5_arncliffe.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/narelland_campbelltown.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/parra_ashfield.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/princeshwy_batemans.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/princeshwy_bulli.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/alfords_bangorbp.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/elizabethdr_livepool.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/fiveislands_portkembla.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/homebushbay_homebush.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/memorialdr_towradge.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/pacifichwy_macksville.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/pennanthills_beecroft.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/pacifichwy_tomago.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/shellharbour_warilla.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/yorkst_sydney.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/burntbrdg_seaforth.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/kinggeorge_hurstville.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/m5_kingsgrove.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/newsthhead_edgecliff.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/oldsthhead_bondi.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/foreshore_banksmeadow.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/hunterexp_buchanan.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/hunterexp_allandale.jpg','http://www.rms.nsw.gov.au/trafficreports/cameras/camera_images/hunterexp_branxton.jpg']
		for cam in cams:
			noGood = True
			strikes = 0
			while (noGood):
				try:
					urllib.request.urlretrieve(cam, "images/" + str(num) + ".jpg")
					# Save the image as its native resolution: 352x288
					Image.open("images/" + str(num) + ".jpg").resize((352,288)).save("images/" + str(num) + ".jpg")
					noGood = False
				except: # The nature of Australian internet means sometimes connection will be lost
					noGood = True
					strikes += 1
					print("|",end="")
					if strikes == 5: # If we've tried 5 times to no avail, just save a black image for this camer
						Image.new("RGB", (352,288),(0,0,0)).save("images/" + str(num) + ".jpg")
						noGood = False
			num += 1

		# Make a master image large enough to encapsulate all branch images
		im = Image.new("RGB", (11 * 352, 11 * 288))
		for y in range(11):
			for x in range(11):
				try: # Lay each camera's view down in a grid
					new = Image.open("images/" + str(x + y * 11) + ".jpg")
					im.paste(new, (x * 352, y * 288))
				except: # Extremly unlikely, but any error would jeperdise the program from running say overnight
					pass
		
		# We're done with all subimages
		shutil.rmtree("images/")
		# and we'll save the master
		im.save("out/" + str(time.time()) + ".jpg")
		print("!",end="")
		# Make sure we don't run twice (or more) in this minute
		time.sleep(1.1)
	else: # If it's not the first second of the minute, don't waste resources
		time.sleep(.5)